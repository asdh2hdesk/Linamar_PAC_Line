<?xml version="1.0" encoding="UTF-8"?>
<templates>
    <t t-name="manufacturing_dashboard.final_station_dashboard_view" owl="1">
        <div class="final-station-dashboard">
            <div class="container-fluid">
<!--                &lt;!&ndash; Header &ndash;&gt;-->
<!--                <div class="dashboard-header">-->
<!--                    <h1>Final Station Control Center</h1>-->
<!--                    <p>Real-time PLC monitoring and camera control for final stations</p>-->
<!--                </div>-->
                
                <!-- Final Station Dashboard Content -->
                <div t-if="state.final_station" class="final-station-content">
                    <div class="section-header">
                        <h2>Final Station Control: <span t-esc="state.final_station.machine_name"/></h2>
                        <p>Real-time PLC monitoring and camera control</p>
                    </div>

                    <!-- Combined PLC/Camera and Mode Control Card -->
                    <div class="row g-4 mb-4">
                        <!-- PLC & Camera Status Card -->
                        <div class="col-md-8">
                            <div class="card final-station-card">
                                <div class="card-header">
                                    <h5><i class="fa fa-desktop"/> System Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <!-- PLC Status -->
                                        <div class="col-md-6">
                                            <div class="status-section">
                                                <h6><i class="fa fa-plug"/> PLC Status</h6>
                                                <div class="status-indicator" t-attf-class="plc-#{state.final_station.plc_online and 'online' or 'offline'}">
                                                    <i class="fa fa-circle"/>
                                                    <span t-esc="state.final_station.plc_online and 'Online' or 'Offline'"/>
                                                </div>
                                                <div class="info-details">
                                                    <small>IP: <span t-esc="state.final_station.plc_ip_address"/></small><br/>
                                                    <small>Port: <span t-esc="state.final_station.plc_port"/></small><br/>
                                                    <small>Last Comm: <span t-esc="state.final_station.last_plc_communication and formatTime(state.final_station.last_plc_communication) or 'Never'"/></small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Camera Status -->
                                        <div class="col-md-6">
                                            <div class="status-section">
                                                <h6><i class="fa fa-camera"/> Camera Status</h6>
                                                <div class="status-indicator" t-attf-class="camera-#{state.final_station.camera_triggered and 'active' or 'inactive'}">
                                                    <i class="fa fa-circle"/>
                                                    <span t-esc="state.final_station.camera_triggered and 'Active' or 'Inactive'"/>
                                                </div>
                                                <div class="info-details">
                                                    <small>IP: <span t-esc="state.final_station.camera_ip_address"/></small><br/>
                                                    <small>Port: <span t-esc="state.final_station.camera_port"/></small><br/>
                                                    <small>Last Scan: <span t-esc="state.final_station.last_capture_time and formatTime(state.final_station.last_capture_time) or 'Never'"/></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Operation Mode & Part Status Card -->
                        <div class="col-md-4">
                            <div class="card final-station-card">
                                <div class="card-header">
                                    <h5><i class="fa fa-cogs"/> Control And Status</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Operation Mode -->
                                    <div class="mode-section mb-3">
                                        <h6><i class="fa fa-toggle-on"/> Operation Mode</h6>
                                        <div class="mode-display" t-attf-class="mode-#{state.final_station.operation_mode}">
                                            <i class="fa" t-attf-class="fa-#{state.final_station.operation_mode === 'auto' and 'play-circle' or 'hand-paper-o'}"/>
                                            <span t-esc="state.final_station.operation_mode and state.final_station.operation_mode.toUpperCase() or 'UNKNOWN'"/>
                                        </div>
                                        <div class="mode-controls">
                                            <button type="button" class="btn btn-sm btn-primary toggle-mode-btn" t-on-click="toggleOperationMode">
                                                <i class="fa fa-exchange"/> Toggle Mode
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Part Status -->
                                    <div class="part-section">
                                        <h6><i class="fa fa-cube"/> Part Status</h6>
                                        <div class="status-indicator" t-attf-class="part-#{state.final_station.part_present and 'present' or 'absent'}">
                                            <i class="fa fa-circle"/>
                                            <span t-esc="state.final_station.part_present and 'Present' or 'Absent'"/>
                                        </div>
                                        <div class="info-details">
                                            <small>Processing: <span t-esc="state.final_station.processing_part and 'Yes' or 'No'"/></small><br/>
                                            <small>Last Serial: <span t-esc="state.final_station.last_serial_number"/></small><br/>
                                            <small>Result: <span t-esc="state.final_station.last_result" class="result-badge"/></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Controls Card (Only show in Manual Mode) -->
                    <div t-if="state.final_station.operation_mode === 'manual'" class="row g-4 mb-4">
                        <div class="col-md-12">
                            <div class="card final-station-card manual-controls-card">
                                <div class="card-header">
                                    <h5><i class="fa fa-hand-paper-o"/> Manual Controls</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-warning btn-block manual-camera-btn" t-on-click="manualTriggerCamera">
                                                <i class="fa fa-camera"/> Trigger Camera
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-info btn-block check-part-btn" t-on-click="checkPartPresence">
                                                <i class="fa fa-search"/> Check Part
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-success btn-block cylinder-forward-btn" t-on-click="cylinderForward">
                                                <i class="fa fa-arrow-right"/> Cylinder Forward
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-warning btn-block cylinder-reverse-btn" t-on-click="cylinderReverse">
                                                <i class="fa fa-arrow-left"/> Cylinder Reverse
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Auto Monitoring Card (Only show in Auto Mode) -->
                    <div t-if="state.final_station.operation_mode === 'auto'" class="row g-4 mb-4">
                        <div class="col-md-12">
                            <div class="card final-station-card auto-monitoring-card">
                                <div class="card-header">
                                    <h5><i class="fa fa-play-circle"/> Auto Monitoring</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="auto-status">
                                                <div class="status-indicator" t-attf-class="auto-#{state.final_station.plc_monitoring_active and 'active' or 'inactive'}">
                                                    <i class="fa fa-circle"/>
                                                    <span t-esc="state.final_station.plc_monitoring_active and 'Active' or 'Inactive'"/>
                                                </div>
                                                <div class="auto-info">
                                                    <small>Scan Rate: <span t-esc="state.final_station.plc_scan_rate"/>s</small><br/>
                                                    <small>Last Scan: <span t-esc="state.final_station.last_plc_scan and formatTime(state.final_station.last_plc_scan) or 'Never'"/></small><br/>
                                                    <small>Errors: <span t-esc="state.final_station.plc_monitoring_errors"/></small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="auto-controls">
                                                <button type="button" class="btn btn-success btn-sm start-monitoring-btn" t-on-click="startMonitoring">
                                                    <i class="fa fa-play"/> Start Monitoring
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm stop-monitoring-btn" t-on-click="stopMonitoring">
                                                    <i class="fa fa-stop"/> Stop Monitoring
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PLC Registers Card -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-12">
                            <div class="card final-station-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fa fa-list"/> PLC Registers (D0-D9)</h5>
                                    <button type="button" class="btn btn-sm btn-primary test-plc-btn" t-on-click="testPLCConnection">
                                        <i class="fa fa-plug"/> Test Connection
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row register-grid">
                                        <t t-foreach="Array.from({length: 10}, (_, i) => i)" t-as="i" t-key="i">
                                            <div class="col-md-1 register-item">
                                                <div class="register-label">D<span t-esc="i"/></div>
                                                <div class="register-value" t-att-data-register="i">--</div>
                                            </div>
                                        </t>
                                    </div>
                                    <div class="register-info">
                                        <small>
                                            D0: Part Presence | D1: Result (0=OK, 1=NOK) | D2: Mode (0=Auto, 1=Manual) | 
                                            D3: Cylinder Forward | D4: Cylinder Reverse | D5-D9: Reserved
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Station Results Card -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-12">
                            <div class="card final-station-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fa fa-check-square-o"/> Station Results
                                        <span t-if="state.station_results" class="badge badge-info ml-2" t-esc="state.station_results.serial_number"/>
                                    </h5>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" t-on-click="refreshStationResults" t-if="state.final_station and state.final_station.last_serial_number">
                                            <i class="fa fa-refresh"></i> Refresh
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" t-on-click="createTestStationResults" t-if="state.final_station">
                                            <i class="fa fa-flask"></i> Test
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" t-on-click="triggerAutoMonitoring" t-if="state.final_station">
                                            <i class="fa fa-play"></i> Auto Start
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" t-on-click="checkPLCStatus" t-if="state.final_station">
                                            <i class="fa fa-info"></i> Check Status
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" t-on-click="restartPLCMonitoring" t-if="state.final_station">
                                            <i class="fa fa-refresh"></i> Restart PLC
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" t-on-click="resetProcessingFlag" t-if="state.final_station">
                                            <i class="fa fa-undo"></i> Reset Processing
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" t-on-click="testConnection" t-if="state.final_station">
                                            <i class="fa fa-plug"></i> Test Connection
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div t-if="state.station_results" class="station-results">
                                        <!-- Overall Status -->
                                        <div class="overall-status mb-3 p-3 border rounded" t-attf-class="bg-#{state.station_results.overall_status === 'pass' and 'success' or state.station_results.overall_status === 'reject' and 'danger' or 'warning'}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>Overall Status:</strong>
                                                <span t-attf-class="badge badge-#{state.station_results.overall_status === 'pass' and 'success' or state.station_results.overall_status === 'reject' and 'danger' or 'warning'}" t-esc="state.station_results.overall_status"/>
                                            </div>
                                        </div>
                                        
                                        <!-- Individual Station Results -->
                                        <div class="stations-list">
                                            <t t-foreach="state.station_results.stations" t-as="station" t-key="station.name">
                                                <div class="station-item d-flex justify-content-between align-items-center mb-2 p-3 border rounded">
                                                    <div class="d-flex align-items-center">
                                                        <i t-attf-class="fa #{station.status} #{station.color} mr-3" style="font-size: 20px;"></i>
                                                        <span class="font-weight-bold" t-esc="station.name"/>
                                                    </div>
                                                    <div class="text-end">
                                                        <span t-attf-class="badge badge-#{station.result === 'pass' and 'success' or station.result === 'reject' and 'danger' or 'warning'}" t-esc="station.result"/>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                        
                                        <!-- QE Override Info -->
                                        <div t-if="state.station_results.qe_override" class="qe-override mt-3 p-3 border rounded bg-info">
                                            <div class="d-flex align-items-center">
                                                <i class="fa fa-user-circle mr-2"></i>
                                                <div>
                                                    <strong>QE Override Active</strong>
                                                    <br/>
                                                    <small t-esc="state.station_results.qe_comments"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div t-else="" class="text-center text-muted py-4">
                                        <i class="fa fa-info-circle fa-2x mb-2"></i>
                                        <p>No station results available</p>
                                        <small>Scan a part to see station results</small>
                                        <br/>
                                        <small class="text-info">Last Serial: <span t-esc="state.final_station and state.final_station.last_serial_number or 'None'"/></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Measurements Card -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-12">
                            <div class="card final-station-card">
                                <div class="card-header">
                                    <h5><i class="fa fa-history"/> Recent Measurements</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Serial Number</th>
                                                    <th>Time</th>
                                                    <th>Result</th>
                                                    <th>Mode</th>
                                                    <th>Trigger</th>
                                                </tr>
                                            </thead>
                                            <tbody class="measurements-table">
                                                <!-- Measurements will be loaded via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Part Popup -->
        <div t-if="state.final_station and state.final_station.processing_part" class="processing-popup-overlay" t-on-click="closeProcessingPopup">
            <div class="processing-popup" t-on-click.stop="">
                <div class="processing-popup-header">
                    <h4><i class="fa fa-cog fa-spin"/> Processing Part</h4>
                </div>
                <div class="processing-popup-body">
                    <div class="processing-info">
                        <p><strong>Serial Number:</strong> <span t-esc="state.final_station.last_serial_number"/></p>
                        <p><strong>Status:</strong> <span class="text-warning">Processing...</span></p>
                        <p><strong>Mode:</strong> <span t-esc="state.final_station.operation_mode and state.final_station.operation_mode.toUpperCase()"/></p>
                    </div>
                    <div class="processing-animation">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Processing...</span>
                        </div>
                    </div>
                </div>
                <div class="processing-popup-footer">
                    <button type="button" class="btn btn-secondary btn-sm" t-on-click="resetProcessingFlag">
                        <i class="fa fa-undo"/> Reset Processing
                    </button>
                </div>
            </div>
        </div>
    </t>
</templates>
